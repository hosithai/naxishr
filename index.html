function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var doc = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = doc.getActiveSheet();
    var data = JSON.parse(e.postData.contents);

    // Xử lý lưu ảnh vào Drive (Nếu có ảnh)
    var imageUrl = "";
    if (data.image && data.image.length > 100) {
      try {
        var imageBytes = Utilities.base64Decode(data.image.split(',')[1]);
        // Đặt tên ảnh theo: Tên_SốCCCD.jpg
        var fileName = data.hoTen + "_" + data.soCCCD + ".jpg";
        var blob = Utilities.newBlob(imageBytes, "image/jpeg", fileName);
        var file = DriveApp.createFile(blob);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        imageUrl = file.getUrl();
      } catch (err) {
        imageUrl = "Lỗi lưu ảnh";
      }
    }

    // Ghi dữ liệu vào Sheet
    sheet.appendRow([
      Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd/MM/yyyy HH:mm:ss"), // A
      data.hoTen,       // B
      "'" + data.ngaySinh, // C (Thêm ' để giữ định dạng ngày)
      "'" + data.soCCCD,   // D (Thêm ' để giữ số 0 đầu)
      data.queQuan,     // E
      "'" + data.sdt,   // F
      data.phongBan,    // G
      data.viTri,       // H
      data.mucLuong,    // I
      data.kinhNghiem,  // J
      data.honNhan,     // K
      imageUrl          // L
    ]);

    return ContentService.createTextOutput(JSON.stringify({ 'result': 'success' })).setMimeType(ContentService.MimeType.JSON);

  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ 'result': 'error', 'error': e.toString() })).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}
