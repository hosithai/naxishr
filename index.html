<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuy·ªÉn D·ª•ng & Qu√©t CCCD</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { background-color: #f0f2f5; font-family: Arial, sans-serif; }
        .container { max-width: 600px; margin-top: 20px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 20px; background: black; }
        .hidden { display: none; }
        .section-title { font-size: 1.1rem; font-weight: bold; color: #0d6efd; margin-top: 20px; margin-bottom: 10px; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="container mb-5">
    <h3 class="text-center text-primary fw-bold mb-4">TH√îNG TIN ·ª®NG VI√äN</h3>

    <!-- CAMERA -->
    <div id="reader" class="hidden"></div>
    <button id="toggleCamera" class="btn btn-warning w-100 mb-3 fw-bold">üì∑ Qu√©t QR CCCD (H·ªó tr·ª£ nh·∫≠p li·ªáu)</button>
    <p id="scanStatus" class="text-center text-success fw-bold"></p>

    <form id="infoForm">
        <div class="section-title">1. Th√¥ng tin c√° nh√¢n</div>
        
        <div class="mb-3">
            <label class="form-label">S·ªë CCCD / CMND</label>
            <input type="number" class="form-control" id="soCCCD" placeholder="Qu√©t QR ho·∫∑c nh·∫≠p tay...">
        </div>

        <div class="mb-3">
            <label class="form-label">H·ªç v√† T√™n</label>
            <input type="text" class="form-control" id="hoTen" required placeholder="Nh·∫≠p h·ªç t√™n in hoa...">
        </div>

        <div class="row">
            <div class="col-6 mb-3">
                <label class="form-label">Ng√†y sinh</label>
                <input type="date" class="form-control" id="ngaySinh" required>
            </div>
            <div class="col-6 mb-3">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                <input type="number" class="form-control" id="sdt" required placeholder="09xxxx...">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Qu√™ qu√°n (Ch·ªçn T·ªânh - Huy·ªán)</label>
            <div class="d-flex gap-2">
                <select class="form-select" id="province" required>
                    <option value="">Ch·ªçn T·ªânh/TP...</option>
                </select>
                <select class="form-select" id="district" required disabled>
                    <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán...</option>
                </select>
            </div>
            <!-- Tr∆∞·ªùng ·∫©n ƒë·ªÉ l∆∞u chu·ªói ƒë·ªãa ch·ªâ full g·ª≠i ƒëi -->
            <input type="hidden" id="queQuanFull">
        </div>

        <div class="section-title">2. Th√¥ng tin ·ª©ng tuy·ªÉn</div>

        <div class="row">
            <div class="col-6 mb-3">
                <label class="form-label">Ph√≤ng ban</label>
                <select class="form-select" id="phongBan" required>
                    <option value="" disabled selected>Ch·ªçn...</option>
                    <option value="TAG">TAG</option>
                    <option value="CARE">CARE</option>
                    <option value="KHO">KHO</option>
                    <option value="CS">CS</option>
                    <option value="MUA HANG">MUA HANG</option>
                    <option value="DTP">DTP</option>
                    <option value="SX">SX</option>
                    <option value="XNK">XNK</option>
                    <option value="TV">TV</option>
                    <option value="IT">IT</option>
                    <option value="ACC">ACC</option>
                </select>
            </div>
            <div class="col-6 mb-3">
                <label class="form-label">V·ªã tr√≠</label>
                <select class="form-select" id="viTri" required>
                    <option value="" disabled selected>Ch·ªçn...</option>
                    <option value="C√¥ng nh√¢n">C√¥ng nh√¢n</option>
                    <option value="Sub CS">Sub CS</option>
                    <option value="Staff">Staff</option>
                    <option value="Supervisor">Supervisor</option>
                    <option value="Manager">Manager</option>
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-6 mb-3">
                <label class="form-label">M·ª©c l∆∞∆°ng (Tri·ªáu VNƒê)</label>
                <input type="number" class="form-control" id="mucLuong" step="0.5" placeholder="VD: 8.5">
            </div>
            <div class="col-6 mb-3">
                <label class="form-label">Kinh nghi·ªám</label>
                <input type="text" class="form-control" id="kinhNghiem" placeholder="VD: 1 nƒÉm...">
            </div>
        </div>

        <div class="section-title">3. ·∫¢nh ch·ª•p CCCD</div>
        <div class="mb-4">
            <input type="file" class="form-control" id="cameraInput" accept="image/*" capture="environment">
            <div class="form-text text-muted">Ch·ª•p ·∫£nh m·∫∑t tr∆∞·ªõc r√µ n√©t. H·ªá th·ªëng s·∫Ω t·ª± n√©n ·∫£nh.</div>
        </div>

        <button type="submit" id="submitBtn" class="btn btn-primary w-100 py-3 fw-bold fs-5">üöÄ G·ª¨I H·ªí S∆†</button>
    </form>
</div>

<script>
    // ==========================================
    // üëá D√ÅN LINK APPS SCRIPT C·ª¶A B·∫†N V√ÄO ƒê√ÇY üëá
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwnOJhg-fz8wN3-JVVXODrPPNPJJ-kCpPFtCtr2VqF2SvPlR-S_hsjy9ZVWG9ng6YrOhA/exec"; 
    // ==========================================

    // 1. T·∫£i danh s√°ch T·ªânh/Th√†nh Vi·ªát Nam (D√πng API mi·ªÖn ph√≠)
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    let locationData = [];

    fetch('https://provinces.open-api.vn/api/?depth=2')
        .then(response => response.json())
        .then(data => {
            locationData = data;
            data.forEach(p => {
                let option = document.createElement('option');
                option.value = p.code;
                option.text = p.name;
                provinceSelect.add(option);
            });
        })
        .catch(err => console.error("L·ªói t·∫£i ƒë·ªãa ch·ªâ:", err));

    // X·ª≠ l√Ω khi ch·ªçn T·ªânh -> Hi·ªán Huy·ªán
    provinceSelect.addEventListener('change', function() {
        districtSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán...</option>';
        districtSelect.disabled = true;
        
        const selectedCode = this.value;
        const province = locationData.find(p => p.code == selectedCode);
        
        if (province && province.districts) {
            districtSelect.disabled = false;
            province.districts.forEach(d => {
                let option = document.createElement('option');
                option.value = d.name; // L∆∞u t√™n huy·ªán
                option.text = d.name;
                districtSelect.add(option);
            });
        }
    });

    // 2. X·ª≠ l√Ω Camera Qu√©t QR
    let html5QrCode;
    let isCameraOn = false;

    document.getElementById('toggleCamera').addEventListener('click', function() {
        if (!isCameraOn) {
            document.getElementById('reader').classList.remove('hidden');
            this.innerText = "üõë D·ª´ng qu√©t";
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
            (decodedText) => {
                // Khi qu√©t th√†nh c√¥ng
                html5QrCode.stop();
                document.getElementById('reader').classList.add('hidden');
                document.getElementById('toggleCamera').innerText = "üì∑ Qu√©t l·∫°i QR";
                document.getElementById('scanStatus').innerText = "‚úÖ ƒê√£ qu√©t xong!";
                isCameraOn = false;

                // X·ª≠ l√Ω d·ªØ li·ªáu QR CCCD
                const parts = decodedText.split('|');
                if (parts.length >= 6) {
                    // D·ªØ li·ªáu chu·∫©n CCCD Chip
                    document.getElementById('soCCCD').value = parts[0];
                    document.getElementById('hoTen').value = parts[2];
                    
                    // Format ng√†y sinh (ddMMyyyy -> yyyy-MM-dd cho input type=date)
                    const dobRaw = parts[3];
                    const dobISO = `${dobRaw.slice(4)}-${dobRaw.slice(2,4)}-${dobRaw.slice(0,2)}`;
                    document.getElementById('ngaySinh').value = dobISO;
                    
                    // ƒê·ªãa ch·ªâ t·ª´ QR (Th∆∞·ªùng tr√∫) - G·ª£i √Ω v√†o √¥
                    // Tuy nhi√™n v√¨ ta d√πng Dropdown T·ªânh/Huy·ªán n√™n ch·ªâ hi·ªÉn th·ªã g·ª£i √Ω
                    alert("ƒê√£ l·∫•y ƒë∆∞·ª£c th√¥ng tin: " + parts[2] + "\nQu√™ qu√°n trong QR: " + parts[5] + "\nVui l√≤ng ch·ªçn T·ªânh/Huy·ªán t∆∞∆°ng ·ª©ng trong danh s√°ch.");
                } else {
                    // QR ki·ªÉu c≈© ho·∫∑c ch·ªâ c√≥ s·ªë
                    document.getElementById('soCCCD').value = decodedText;
                    alert("M√£ QR n√†y ch·ªâ ch·ª©a s·ªë: " + decodedText + ". Vui l√≤ng nh·∫≠p tay c√°c th√¥ng tin c√≤n l·∫°i.");
                }
            })
            .catch(err => alert("Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera: " + err));
            isCameraOn = true;
        } else {
            html5QrCode.stop();
            document.getElementById('reader').classList.add('hidden');
            this.innerText = "üì∑ Qu√©t QR CCCD";
            isCameraOn = false;
        }
    });

    // 3. H√†m n√©n ·∫£nh (Resize image) tr∆∞·ªõc khi g·ª≠i
    // Google Apps Script gi·ªõi h·∫°n dung l∆∞·ª£ng, n√™n c·∫ßn resize ·∫£nh nh·ªè l·∫°i < 1MB
    const processImage = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Gi·ªõi h·∫°n chi·ªÅu r·ªông 800px
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Xu·∫•t ra base64 jpeg ch·∫•t l∆∞·ª£ng 0.7
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            };
            reader.onerror = error => reject(error);
        });
    }

    // 4. G·ª≠i Form
    document.getElementById('infoForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Ki·ªÉm tra link
        if (GOOGLE_SCRIPT_URL.includes("D√ÅN_LINK")) {
            alert("Ch∆∞a c·∫•u h√¨nh Link Google Script!");
            return;
        }

        const btn = document.getElementById('submitBtn');
        const oldText = btn.innerText;
        btn.innerText = "‚è≥ ƒêang n√©n ·∫£nh & G·ª≠i...";
        btn.disabled = true;

        // X·ª≠ l√Ω ƒë·ªãa ch·ªâ
        const pIndex = provinceSelect.selectedIndex;
        const pName = pIndex > 0 ? provinceSelect.options[pIndex].text : "";
        const dName = districtSelect.value;
        const fullAddress = dName ? `${dName}, ${pName}` : pName;

        // X·ª≠ l√Ω ·∫£nh
        let imageBase64 = "";
        const fileInput = document.getElementById('cameraInput');
        if (fileInput.files.length > 0) {
            try {
                imageBase64 = await processImage(fileInput.files[0]);
            } catch (err) {
                console.error(err);
                alert("L·ªói x·ª≠ l√Ω ·∫£nh!");
            }
        }

        const data = {
            soCCCD: document.getElementById('soCCCD').value,
            hoTen: document.getElementById('hoTen').value.toUpperCase(),
            ngaySinh: document.getElementById('ngaySinh').value, // yyyy-mm-dd
            sdt: document.getElementById('sdt').value,
            queQuan: fullAddress,
            phongBan: document.getElementById('phongBan').value,
            viTri: document.getElementById('viTri').value,
            mucLuong: document.getElementById('mucLuong').value,
            kinhNghiem: document.getElementById('kinhNghiem').value,
            image: imageBase64
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', // Quan tr·ªçng
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(() => {
            alert("‚úÖ G·ª≠i h·ªì s∆° th√†nh c√¥ng!");
            btn.innerText = oldText;
            btn.disabled = false;
            window.location.reload();
        })
        .catch(error => {
            alert("L·ªói: " + error);
            btn.innerText = oldText;
            btn.disabled = false;
        });
    });
</script>

</body>
</html>
